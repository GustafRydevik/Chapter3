## This file contains results from the single model runs
##Contains code for figures 
##

library(ggplot2)
library(data.table)
#### example of a Lotka-Volterra graph 
theme_thesis<-theme_minimal(base_size=14)
ggsave_thesis<-function(file.name,plot.name){ggsave(file.name,plot.name,width=8,height=5,units="in",dpi=100)}


##Figure 3.1  ####
lv.example.df<-data.frame(time=seq(1,10,by=0.1),LotkaVolterra.Fun(diseaseType1)(seq(1,10,by=0.1)))
lv.example.p<-ggplot(data=lv.example.df,aes(x=time))+
  geom_line(aes(y=t1),col="red",size=2)+
  geom_line(aes(y=t2),col="blue",size=2)+
  ylab("test response")+ggtitle("Example of a Lotka-Volterra modelled test response curve")+theme_thesis
ggsave_thesis(file.path(output.path,"Fig_3_2_lV_example.png"),plot.name=lv.example.p)


lv.pars.df<-data.frame(
  Type=c("Incubating pathogen","Fast-acting pathogen","Chronic infection with acute phase"),
  b_NA=c(diseaseType1$parms["growth.na"],diseaseType2$parms["growth.na"],diseaseType3$parms["growth.na"]),
  h=c(diseaseType1$parms["killed.na"],diseaseType2$parms["killed.na"],diseaseType3$parms["killed.na"]),
  b_ab=c(diseaseType1$parms["feed.ab"],diseaseType2$parms["feed.ab"],diseaseType3$parms["feed.ab"]),
  d_ab=c(diseaseType1$parms["dieoff.ab"],diseaseType2$parms["dieoff.ab"],diseaseType3$parms["dieoff.ab"])
)
library(pander)
pandoc.table(lv.pars.df)

###Lotka Volterra graphs for three types of diseases. 
##Figure 3.2  ####

lv.all.df<-data.frame(Type=rep(c("Incubating pathogen",
                                 "Fast-acting pathogen","Chronic infection with acute phase"),
                               each=length(seq(1,20,by=0.01))),
                      time=seq(1,20,by=0.01),ab=c(
                        LotkaVolterra.Fun(diseaseType1)(seq(1,20,by=0.01))[,1],
                        LotkaVolterra.Fun(diseaseType2)(seq(1,20,by=0.01))[,1],
                        LotkaVolterra.Fun(diseaseType3)(seq(1,20,by=0.01))[,1]),
                      na=c(
                        LotkaVolterra.Fun(diseaseType1)(seq(1,20,by=0.01))[,2],
                        LotkaVolterra.Fun(diseaseType2)(seq(1,20,by=0.01))[,2],
                        LotkaVolterra.Fun(diseaseType3)(seq(1,20,by=0.01))[,2])
)


lv.timeplot.all<-ggplot(data=lv.all.df,aes(x=time))+
  geom_line(aes(y=ab),col="red",size=2)+
  geom_line(aes(y=na),col="blue",size=2)+facet_wrap(~Type,ncol=1,scales="free_y",as.table=FALSE)+
  scale_x_continuous(limits=c(0,20))+ylab("test value")

set.seed(1000)
lv.all.df$ab.obs<-ifelse((1:length(lv.all.df$ab))%in%sample(1:length(lv.all.df$ab),1000),
  rlnorm(length(lv.all.df$ab),meanlog=log(lv.all.df$ab),sdlog=log(1.25)),NA)
lv.all.df$na.obs<-ifelse((1:length(lv.all.df$na))%in%sample(1:length(lv.all.df$na),1000),
                                rlnorm(length(lv.all.df$na),meanlog=log(lv.all.df$na),sdlog=log(1.25)),
                         NA)

lv.phaseplot.all<-ggplot(data=lv.all.df,aes(x=ab,y=na))+
  facet_wrap(~Type,as.table=FALSE,scales="free",ncol=1)+
  geom_point(aes(x=ab.obs,y=na.obs),alpha=0.75,size=3)+
  geom_point(col="red",size=2)+
  ylab("Nucleic acid")+xlab("Antibodies")+
  geom_segment(aes(x=ab.obs,xend=ab,y=na.obs,yend=na),size=0.5,alpha=0.5,linetype=2)
lv.phaseplot.all
library(gridExtra)
lv.time.phase<-arrangeGrob(lv.timeplot.all+theme_thesis,lv.phaseplot.all+theme_thesis,nrow=1)
ggsave(file.path(output.path,"Fig_3_3_LV_phase_time.png"),plot.name=lv.time.phase,width=8,height=8,units="in",dpi=round(400/7))

###Figure 3.3 generated by running the script below

source(file.path(script.path,"hindcast_likelihood_plotting.R"))

##Posterior plots
library(ggmcmc)


##Evaluating likelihood

hindcast.ll<-function(data,type="linear",diseaseType="DiseaseType1",pars){
  if(type!=linear){error("Only the linear model is implemented!")}
  if(type==linear){
    trend<-pars$trend
    incidence<-pars$incidence
    sd<-pars[grep("sd",names(pars))]
    InfTimes<-pars[grep("InfTime",names(pars))]
    
    E.data<-LotkaVolterra.Fun(disease=get(diseaseType))(InfTimes)
    data.diff<-data/E.data
    plnorm()
  }
  
}



load(file.path(sim.dir,"diseaseType3_EndemicDecreaseFixedSD_seed_1002_t2_samplesize5000_00_gr1.RData"))
#load(file.path(sim.dir,"diseaseType3_EndemicKnownTimes_seed_1002_t2_samplesize2000_00_gr1.RData"))

censorLimit<-(scenarios.results$control.vars$end.time-scenarios.results$control.vars$start.time)
ggs.decrease<-ggs(scenarios.results$est)
decrease.true.inftime<-data.frame(true.inftime=scenarios.results$true.values$infection.times)
decrease.true.inftime$Parameter<-paste0("InfTime[",1:nrow(decrease.true.inftime),"]")
decrease.true.inftime$scenario<-"decrease"
decrease.true.pars<-data.frame(scenarios.results$control.vars,scenario="decrease")
decrease.obs<-scenarios.results$true.values$test.obsvalues


load(file.path(sim.dir,"diseaseType3_EndemicConstantFixedSD_seed_1000_t2_samplesize5000_00_gr1.RData"))
#load(file.path(sim.dir,"diseaseType3_EndemicKnownTimes_seed_1000_t2_samplesize2000_00_gr1.RData"))
ggs.constant<-ggs(scenarios.results$est)

constant.true.inftime<-data.frame(true.inftime=scenarios.results$true.values$infection.times)
constant.true.inftime$Parameter<-paste0("InfTime[",1:nrow(constant.true.inftime),"]")
constant.true.inftime$scenario<-"constant"
constant.true.pars<-data.frame(scenarios.results$control.vars,scenario="constant")
constant.obs<-scenarios.results$true.values$test.obsvalues


load(file.path(sim.dir,"diseaseType3_EndemicIncreaseFixedSD_seed_1001_t2_samplesize5000_00_gr1.RData"))
#load(file.path(sim.dir,"diseaseType3_EndemicKnownTimes_seed_1001_t2_samplesize2000_00_gr1.RData"))
ggs.increase<-ggs(scenarios.results$est)
increase.true.inftime<-data.frame(true.inftime=scenarios.results$true.values$infection.times)
increase.true.inftime$Parameter<-paste0("InfTime[",1:nrow(increase.true.inftime),"]")
increase.true.inftime$scenario<-"increase"
increase.true.pars<-data.frame(scenarios.results$control.vars,scenario="increase")
increase.obs<-scenarios.results$true.values$test.obsvalues


ggs.all<-rbind(data.frame(ggs.increase,scenario="increase"),
               data.frame(ggs.decrease,scenario="decrease"),
               data.frame(ggs.constant,scenario="constant"))

true.pars<-rbind(increase.true.pars,decrease.true.pars,constant.true.pars)
true.pars<-transform(true.pars,mean.incidence=incidence+end.time/2*trend)
est.trendpars<-subset(ggs.all,Parameter%in%c("incidence","trend","mean.incidence"))
est.inftime<-subset(ggs.all,grepl("InfTime",Parameter))


trendpars.mean<-ddply(subset(est.trendpars,max(Iteration)-Iteration<101),.(Parameter,Chain,scenario),summarise,
                      meanPar=mean(value)
                      )

est.trendpars.dt<-data.table(est.trendpars)
trendpars.ci<-est.trendpars.dt[max(Iteration)-Iteration<101,list(meanPar=mean(value),
          lower.ci=quantile(value,0.025),
          upper.ci=quantile(value,0.975)),by=list(Parameter,scenario)]
#true.inftime<-data.frame(true.inftime=scenarios.results$true.values$infection.times)
#true.inftime$Parameter<-paste0("InfTime[",1:nrow(true.inftime),"]")

obsvalues<-rbindlist(list(data.frame(increase.obs,scenario="A"),
                          data.frame(decrease.obs,scenario="B"),
                          data.frame(constant.obs,scenario="C")))
library(data.table)
increase.true.inftime<-data.table(increase.true.inftime, key="Parameter,scenario")
decrease.true.inftime<-data.table(decrease.true.inftime, key="Parameter,scenario")
constant.true.inftime<-data.table(constant.true.inftime, key="Parameter,scenario")
est.inftime<-data.table(est.inftime,key="Parameter,scenario")
true.inftime<-rbindlist(list(increase.true.inftime,
                             decrease.true.inftime,
                             constant.true.inftime))


all.inftime<-merge(rbindlist(list(increase.true.inftime,
                         decrease.true.inftime,
                         constant.true.inftime)),est.inftime,by=c("Parameter","scenario"))


###scatterplot of trend vs incidence
library(gridExtra)
increase.trace<-ggs_traceplot(ggs.increase,"incidence|trend")
decrease.trace<-ggs_traceplot(ggs.decrease,"incidence|trend")
constant.trace<-ggs_traceplot(ggs.constant,"incidence|trend")
mcmc.trace<-arrangeGrob(Increase=increase.trace+theme_thesis,Decrease=decrease.trace+theme_thesis,Constant=constant.trace+theme_thesis,nrow=1,ncol=3,main="\nMCMC traceplots for increasing,\n decreasing and constant scenarios.")
ggsave_thesis(file.path(output.path,"fig_3_4_mcmc_traceplots.png"),plot.name=mcmc.trace)



##Fig 3.4 - alpha_beta trajectories
p.ab.traj<-ggplot(recast(est.trendpars,scenario+Chain+Iteration~Parameter,measure.var="value"),aes(x=incidence,y=trend,col=Iteration))+
  geom_line(alpha=0.75)+geom_point(alpha=0.75)+
  geom_vline(data=true.pars,
             aes(xintercept=incidence),alpha=0.5,size=2)+
  geom_hline(data=true.pars,
             aes(yintercept=trend),alpha=0.5,size=2)+
  facet_grid(scenario~Chain,scales="free")+theme_thesis
ggsave_thesis(file.path(output.path,"fig_3_5_trajectories_alpha_beta.png"),plot.name=p.ab.traj)




##Chapter figure below! 
##Figure 3.5 - posterior of trends
p.post.density<-ggplot(data=est.trendpars,
       aes(x=value,group=Chain))+
  geom_density(aes(fill=factor(Chain)),alpha=0.3)+
  facet_grid(scenario~Parameter,scales="free")+
  geom_vline(data=subset(melt(true.pars,variable.name="Parameter"),Parameter%in%c("incidence","trend","mean.incidence")),
             aes(xintercept=value))+theme_thesis
ggsave_thesis(file.path(output.path,"fig_3_6_posterior_trend.png"),plot.name=p.post.density)

#Residual plot below - indicates that for InfTime>17, the probability that the time of infection is ~0
# is non-zero


lineardist<-function(time,alpha,beta,chain){
  alpha<-alpha[chain]
  beta<-beta[chain]
  (alpha+beta*time)*exp(-(alpha+beta*time/2)*time)}


### Creating data for plotting estimated trend lines below here 
estTrend.df<- as.data.frame(apply(
                          recast(trendpars.mean,Chain+scenario~Parameter,measure.var="meanPar"),
                          1,function(x)lineardist(1:censorLimit,as.numeric(x[3]),as.numeric(x[5]),1)))

trendpars.ci<-data.table(dcast(melt(trendpars.ci,,measure.var=c("meanPar","lower.ci","upper.ci")),scenario~Parameter+variable))

##data.table syntax below!!
estTrend.dt<-trendpars.ci[,list(line.est=lineardist(1:censorLimit,incidence_meanPar,trend_meanPar,1),
                   line.lower=lineardist(1:censorLimit,incidence_lower.ci,trend_lower.ci,1),
                   line.upper=lineardist(1:censorLimit,incidence_upper.ci,trend_upper.ci,1),
             time=1:censorLimit),
             by=scenario]

estTrend.linear.dt<-trendpars.ci[,list(line.est=(1:censorLimit)*trend_meanPar+incidence_meanPar,
                                line.lower=(1:censorLimit)*trend_lower.ci+incidence_lower.ci,
                                line.upper=(1:censorLimit)*trend_upper.ci+incidence_upper.ci,
                                time=1:censorLimit),
                          by=scenario]

trueTrend.df<-do.call("rbind",
        apply(true.pars,1,function(x){
          data.frame(scenario=x[8],Time=1:censorLimit,value=lineardist(1:censorLimit,as.numeric(x[5]),as.numeric(x[6]),1))}
          ))
trueTrend.df<-ddply(trueTrend.df, .(scenario), mutate,
                   weight = sum(value))
colnames(estTrend.df)<-paste0("Chain",rep(1:5,each=3),".scenario.",rep(c("increase","decrease","constant"),5))
estTrend.df<-data.frame(Time=1:censorLimit,estTrend.df)
estTrend.df<-melt(estTrend.df,id.vars="Time",variable.name="Chain")
estTrend.df$scenario<-sapply(strsplit(as.character(estTrend.df$Chain),"\\."),"[",3)
estTrend.df$Chain<-sapply(strsplit(as.character(estTrend.df$Chain),"\\."),"[",1)

estTrend.df$Chain<-as.numeric(as.factor(estTrend.df$Chain))
estTrend.df$TrueCurve<-lineardist(estTrend.df$Time,1/100,1/100/50,1)
estTrend.df<-ddply(estTrend.df, .(Chain,scenario), mutate,
      weight = sum(value))
estTrend.dt<-ddply(estTrend.dt, .(scenario), mutate,
                   weight = sum(line.est))

# 
# ggplot(all.inftime,aes(x=factor(round(true.inftime)),y=value-true.inftime))+
#   geom_violin()+
#   facet_grid(scenario~Chain)
# 


ggplot(all.inftime,aes(x=value))+geom_histogram(aes(y=..count../tapply(..count..,..PANEL..,sum)[..PANEL..]),binwidth=1)+
  facet_grid(scenario~Chain)+
  geom_line(data=estTrend.df,aes(x=Time,y=value/weight),size=1.5)+
  geom_line(data=trueTrend.df,aes(x=Time,y=value/weight),col="red",alpha=0.5,size=1.5)
  
ggplot(all.inftime,aes(x=true.inftime))+geom_histogram(aes(y=..count../tapply(..count..,..PANEL..,sum)[..PANEL..]),binwidth=1)+
  facet_grid(scenario~Chain)+
  geom_line(data=estTrend.df,aes(x=Time,y=value/weight),size=1.5)+
  geom_line(data=trueTrend.df,aes(x=Time,y=value/weight),col="red",alpha=0.5,size=1.5)


##As they occurred trend line below here 
incidence.increase<-EndemicLinearWithReinfections(5000,incidence = 0.05,trend = -0.001666,start.time = 0,end.time=20)/5000
incidence.decrease<-EndemicLinearWithReinfections(5000,incidence = 0.05,trend = 0.001666,start.time = 0,end.time=20)/5000
incidence.constant<-EndemicLinearWithReinfections(5000,incidence = 0.05,trend = 0,start.time = 0,end.time=20)/5000
ongoing.incidence<-rbindlist(list(data.frame(scenario="increase",incidence=incidence.increase,time=0:19),
      data.frame(scenario="decrease",incidence=incidence.decrease,time=0:19),
      data.frame(scenario="constant",incidence=incidence.constant,time=0:19))
)


ggplot(all.inftime,aes(x=value))+geom_histogram(aes(y=..count../tapply(..count..,..PANEL..,sum)[..PANEL..]),binwidth=1)+
  facet_grid(scenario~Chain)+
  geom_line(data=estTrend.df,aes(x=Time,y=value/weight),size=1.5)+
  geom_line(data=trueTrend.df,aes(x=Time,y=value/weight),col="red",alpha=0.5,size=1.5)

estTrend.meanpars<-ddply(estTrend.df,.(scenario,Time),summarize,meanvalue=mean(value))
#all.inftime.mean<-ddply(all.inftime,.(scenario,Iteration,Parameter),summarize,meanvalue=mean(value))

## Thiis expression below uses data.table syntax which is fast but weird! 
all.inftime.mean<-(all.inftime[,list(meanvalue=mean(value)),by=list(scenario,Iteration,Parameter)])

#Chapter fig!
##Fig 3.7 - histogram of times since infection 
p.hist.tsi<-ggplot(all.inftime,aes(x=value))+geom_histogram(aes(y=..count../tapply(..count..,..PANEL..,sum)[..PANEL..]),binwidth=1,fill="lightgrey",col="black")+
  facet_grid(~scenario)+
  geom_ribbon(data=estTrend.dt,aes(x=time,ymin=line.lower/weight,ymax=line.upper/weight),alpha=0.5,col="red")+
  geom_line(data=estTrend.df,aes(x=Time,y=value/weight,col="Estimated_line"),size=2.5)+
  geom_line(data=trueTrend.df,aes(x=Time,y=value/weight,col="True_line"),size=1.5)+
  scale_colour_manual("Density",values=c(Estimated_line="red",True_line="black"))+
  theme_thesis
ggsave_thesis(file.path(output.path,"fig_3_7_hist_tsi.png"),plot.name=p.hist.tsi)

## Add CIs to this! 
#Chapter fig!

trendpars.est<-dcast(ddply(trendpars.mean,.(Parameter,scenario),summarize,meanPar=mean(meanPar)),scenario~Parameter)
p.hist.ongoing<-ggplot(data=ongoing.incidence,aes(x=time,y=incidence))+
  geom_bar(stat = "identity",col="red",fill="red",alpha=0.5)+facet_wrap(~scenario)+
  geom_ribbon(data=estTrend.linear.dt,aes(x=time,ymin=line.lower,ymax=line.upper,y=0),alpha=0.5,col="red")+
  geom_line(data=estTrend.linear.dt,aes(x=time,y=line.est,col="Estimated_line"),size=2.5)+
  scale_colour_manual("Density",values=c(Estimated_line="red"))+
  theme_thesis
  ggsave_thesis(file.path(output.path,"fig_3_8_hist_ongoing.png"),plot.name=p.hist.ongoing)

ggplot(data=obsvalues,aes(x=t1,y=t2))+
  geom_point()+facet_wrap(~scenario)




##scatterplot for evaluating convergence
ggplot(transform(recast(est.trendpars,scenario+Chain+Iteration~Parameter,measure.var="value"),
                 mean.incidence=incidence+trend*censorLimit/2),aes(x=mean.incidence,y=trend))+
  geom_vline(data=true.pars,
             aes(xintercept=trend*censorLimit/2+incidence),alpha=0.5,size=2)+
  geom_hline(data=true.pars,
             aes(yintercept=trend),alpha=0.5,size=2)+
  geom_point(alpha=0.4,aes(col=factor(Chain)))+#geom_line(alpha=0.75)+
  geom_point(data=true.pars,
             aes(y=trend,x=trend*censorLimit/2+incidence,col=scenario),size=5)+
  facet_grid(scenario~Chain,scales="free") 



##nh
ggplot(transform(recast(est.trendpars,scenario+Chain+Iteration~Parameter,measure.var="value"),
                 mean.incidence=incidence+trend*censorLimit/2),aes(x=mean.incidence,y=trend))+
  geom_vline(data=true.pars,
             aes(xintercept=trend*censorLimit/2+incidence),alpha=0.5,size=2)+
  geom_hline(data=true.pars,
             aes(yintercept=trend),alpha=0.5,size=2)+
  geom_point(alpha=0.4,aes(col=factor(Chain)))+#geom_line(alpha=0.75)+
  geom_point(data=true.pars,
             aes(y=trend,x=trend*censorLimit/2+incidence,col=scenario),size=5)+
  facet_grid(scenario~Chain,scales="free") 


## Scatterplot of the posterior for results purposes 
ggplot(transform(recast(est.trendpars,scenario+Chain+Iteration~Parameter,measure.var="value"),
   mean.incidence=incidence+trend*censorLimit/2),aes(x=mean.incidence,y=trend))+
  geom_vline(data=true.pars,
             aes(xintercept=trend*censorLimit/2+incidence),alpha=0.5,size=2)+
  geom_hline(data=true.pars,
             aes(yintercept=trend),alpha=0.5,size=2)+
   geom_point(alpha=0.4,aes(col=scenario))+#geom_line(alpha=0.75)+
  geom_point(data=true.pars,
              aes(y=trend,x=trend*censorLimit/2+incidence,col=scenario),size=5)


##True histogram 
#hist(true.inftime$true.inftime,freq=FALSE)
#lines(1:30,lineardist(1:30,0.01,0.01/50,chain=1)/mean(1-is.na(true.inftime$true.inftime)))
